<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 2 Cluster analysis of potato cultivars | Nutrient Diagnosis Of Potato</title>
  <meta name="description" content="This is a example of using the bookdown package to write a book for publication on Github. The output format for this example is bookdown::gitbook. Next features are set for after (bibliography and links)." />
  <meta name="generator" content="bookdown 0.10 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 2 Cluster analysis of potato cultivars | Nutrient Diagnosis Of Potato" />
  <meta property="og:type" content="book" />
  
  
  <meta property="og:description" content="This is a example of using the bookdown package to write a book for publication on Github. The output format for this example is bookdown::gitbook. Next features are set for after (bibliography and links)." />
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 2 Cluster analysis of potato cultivars | Nutrient Diagnosis Of Potato" />
  
  <meta name="twitter:description" content="This is a example of using the bookdown package to write a book for publication on Github. The output format for this example is bookdown::gitbook. Next features are set for after (bibliography and links)." />
  

<meta name="author" content="zcoulibali" />


<meta name="date" content="2019-05-26" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="index.html">
<link rel="next" href="Chapitre-Modeling.html">
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />









<style type="text/css">
div.sourceCode { overflow-x: auto; }
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
code > span.kw { color: #007020; font-weight: bold; } /* Keyword */
code > span.dt { color: #902000; } /* DataType */
code > span.dv { color: #40a070; } /* DecVal */
code > span.bn { color: #40a070; } /* BaseN */
code > span.fl { color: #40a070; } /* Float */
code > span.ch { color: #4070a0; } /* Char */
code > span.st { color: #4070a0; } /* String */
code > span.co { color: #60a0b0; font-style: italic; } /* Comment */
code > span.ot { color: #007020; } /* Other */
code > span.al { color: #ff0000; font-weight: bold; } /* Alert */
code > span.fu { color: #06287e; } /* Function */
code > span.er { color: #ff0000; font-weight: bold; } /* Error */
code > span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
code > span.cn { color: #880000; } /* Constant */
code > span.sc { color: #4070a0; } /* SpecialChar */
code > span.vs { color: #4070a0; } /* VerbatimString */
code > span.ss { color: #bb6688; } /* SpecialString */
code > span.im { } /* Import */
code > span.va { color: #19177c; } /* Variable */
code > span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code > span.op { color: #666666; } /* Operator */
code > span.bu { } /* BuiltIn */
code > span.ex { } /* Extension */
code > span.pp { color: #bc7a00; } /* Preprocessor */
code > span.at { color: #7d9029; } /* Attribute */
code > span.do { color: #ba2121; font-style: italic; } /* Documentation */
code > span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code > span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code > span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">A Minimal Book Example</a></li>

<li class="divider"></li>
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> Data processing</a></li>
<li class="chapter" data-level="2" data-path="chapitre-Clustering.html"><a href="chapitre-Clustering.html"><i class="fa fa-check"></i><b>2</b> Cluster analysis of potato cultivars</a></li>
<li class="chapter" data-level="3" data-path="Chapitre-Modeling.html"><a href="Chapitre-Modeling.html"><i class="fa fa-check"></i><b>3</b> Predicting marketable tuber yield</a></li>
<li class="chapter" data-level="4" data-path="Chapitre-Perturbation-vector.html"><a href="Chapitre-Perturbation-vector.html"><i class="fa fa-check"></i><b>4</b> Perturbation vector theory</a><ul>
<li class="chapter" data-level="4.1" data-path="Chapitre-Perturbation-vector.html"><a href="Chapitre-Perturbation-vector.html#dissimilarity-index-between-compositions"><i class="fa fa-check"></i><b>4.1</b> Dissimilarity index between compositions</a></li>
<li class="chapter" data-level="4.2" data-path="Chapitre-Perturbation-vector.html"><a href="Chapitre-Perturbation-vector.html#rebalancing-a-misbalanced-sample-by-perturbation"><i class="fa fa-check"></i><b>4.2</b> Rebalancing a misbalanced sample by perturbation</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="references.html"><a href="references.html"><i class="fa fa-check"></i>References</a></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Nutrient Diagnosis Of Potato</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="chapitre-Clustering" class="section level1">
<h1><span class="header-section-number">Chapter 2</span> Cluster analysis of potato cultivars</h1>
<p>We need a set of packages for data handling. Others will be loaded whenever needed.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(<span class="st">&quot;tidyverse&quot;</span>)       <span class="co"># loads dplyr &amp; ggplot2</span>
<span class="kw">library</span>(<span class="st">&#39;ellipse&#39;</span>)         <span class="co"># plot ellipses</span>
<span class="kw">library</span>(<span class="st">&quot;mvoutlier&quot;</span>)       <span class="co"># sign1, multivariate outliers detection</span>
<span class="kw">library</span>(<span class="st">&quot;ade4&quot;</span>)            <span class="co"># discriminant analysis</span>
<span class="kw">library</span>(<span class="st">&quot;vegan&quot;</span>)           <span class="co"># data clustering</span>
<span class="kw">library</span>(<span class="st">&quot;extrafont&quot;</span>)       <span class="co"># Changing Fonts for Graphs</span></code></pre></div>
<p>We will also use a custom function for discriminant analysis plots.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">source</span>(<span class="st">&#39;https://raw.githubusercontent.com/essicolo/AgFun/master/plotDA_trad.R&#39;</span>)
<span class="kw">source</span>(<span class="st">&quot;https://raw.githubusercontent.com/essicolo/AgFun/master/plotDA_gg.R&quot;</span>)</code></pre></div>
<p>Load data file from previous <code>1.0_data preprocessing.Rmd</code> codes.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">fol_df &lt;-<span class="st"> </span><span class="kw">read.csv2</span>(<span class="st">&quot;data/fol_df.csv&quot;</span>)
<span class="co"># Key columns selection</span>
keys_col &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&#39;NoEssai&#39;</span>, <span class="st">&#39;NoBloc&#39;</span>, <span class="st">&#39;NoTraitement&#39;</span>)
clr_no &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;clr_N&quot;</span>, <span class="st">&quot;clr_P&quot;</span>, <span class="st">&quot;clr_K&quot;</span>, <span class="st">&quot;clr_Mg&quot;</span>, <span class="st">&quot;clr_Ca&quot;</span>, <span class="st">&quot;clr_Fv&quot;</span>)
cult_yield &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&#39;Cultivar&#39;</span>, <span class="st">&#39;Maturity5&#39;</span>, <span class="st">&#39;AnalyseFoliaireStade&#39;</span>, <span class="st">&#39;RendVendable&#39;</span>)</code></pre></div>
<p>For cluster analysis, keep only high yielders, i.e. yield 65% quantile cutter for each cultivar. The <code>cutQ</code> table contains the yield delimiter for each cultivar.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">cutQ &lt;-<span class="st"> </span>fol_df <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">group_by</span>(Cultivar) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">select</span>(RendVendable) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">summarise_if</span>(is.numeric, quantile, <span class="dt">probs=</span><span class="fl">0.65</span>, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">rename</span>(<span class="dt">rv_cut =</span> RendVendable)</code></pre></div>
<pre><code>## Adding missing grouping variables: `Cultivar`</code></pre>
<p>The <code>cutQ</code> table is used to add the variable <code>yieldClass</code> to <code>fol_df</code>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">fol_df &lt;-<span class="st"> </span>fol_df <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">left_join</span>(cutQ, <span class="dt">by =</span> <span class="st">&quot;Cultivar&quot;</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">yieldClass =</span> <span class="kw">fct_relevel</span>(<span class="kw">ifelse</span>(RendVendable <span class="op">&gt;=</span><span class="st"> </span>rv_cut, <span class="st">&quot;HY&quot;</span>, <span class="st">&quot;LY&quot;</span>), <span class="st">&quot;LY&quot;</span>))</code></pre></div>
<p>For sake of verification, we compute average yield per yieldClass.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">meanYield =<span class="st"> </span>fol_df <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">group_by</span>(yieldClass) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">select</span>(RendVendable) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">summarise_if</span>(is.numeric, mean, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>)</code></pre></div>
<pre><code>## Adding missing grouping variables: `yieldClass`</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">meanYield</code></pre></div>
<pre><code>## # A tibble: 3 x 2
##   yieldClass RendVendable
##   &lt;fct&gt;             &lt;dbl&gt;
## 1 LY                 24.8
## 2 HY                 40.4
## 3 &lt;NA&gt;              NaN</code></pre>
<p><code>clr</code> centroids computation</p>
<p>Compositional data transformation is done in the loaded file. We keep only clr-transformed coordinates for high yielders, at 10 % blossom (AnalyseFoliaireStade = 10% fleur).</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">highYielders_df &lt;-<span class="st"> </span>fol_df <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">isNA =</span> <span class="kw">apply</span>(.[<span class="kw">c</span>(clr_no, cult_yield)], <span class="dv">1</span>, anyNA)) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">is10pcf =</span> AnalyseFoliaireStade <span class="op">==</span><span class="st"> &quot;10% fleur&quot;</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">filter</span>(<span class="op">!</span>isNA <span class="op">&amp;</span><span class="st"> </span>is10pcf <span class="op">&amp;</span><span class="st"> </span>yieldClass <span class="op">==</span><span class="st"> &quot;HY&quot;</span> <span class="op">&amp;</span><span class="st"> </span>NoEssai <span class="op">!=</span><span class="st"> &quot;2&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">select</span>(<span class="kw">one_of</span>(keys_col, clr_no, cult_yield)) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">droplevels</span>()
<span class="kw">nrow</span>(highYielders_df)</code></pre></div>
<pre><code>## [1] 1401</code></pre>
<p>So, 1401 lines of observations (or samples) will be used for clustering. Check how many rows of data you have for each cultivar:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">percentage &lt;-<span class="st"> </span><span class="kw">round</span>(<span class="kw">with</span>(highYielders_df, <span class="kw">prop.table</span>(<span class="kw">table</span>(Cultivar)) <span class="op">*</span><span class="st"> </span><span class="dv">100</span>), <span class="dv">2</span>)
distribution &lt;-<span class="st"> </span><span class="kw">with</span>(highYielders_df, <span class="kw">cbind</span>(<span class="dt">nHY =</span> <span class="kw">table</span>(Cultivar), <span class="dt">percent =</span> percentage))

distribution &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="kw">cbind</span>(distribution, <span class="kw">rownames</span>(distribution)))
<span class="kw">colnames</span>(distribution)[<span class="dv">3</span>] &lt;-<span class="st"> &quot;Cultivar&quot;</span>

distribution<span class="op">$</span>nHY &lt;-<span class="st"> </span><span class="kw">as.numeric</span>(<span class="kw">as.character</span>(distribution<span class="op">$</span>nHY)) <span class="co"># nHY = number of samples</span>
distribution<span class="op">$</span>percent &lt;-<span class="st"> </span><span class="kw">as.numeric</span>(<span class="kw">as.character</span>(distribution<span class="op">$</span>percent)) <span class="co"># percentage</span>
distribution <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">arrange</span>(<span class="kw">desc</span>(nHY)) <span class="co"># arrange in descending order</span></code></pre></div>
<pre><code>##    nHY percent           Cultivar
## 1  233   16.63           Goldrush
## 2  203   14.49           Superior
## 3  158   11.28            FL 1207
## 4  132    9.42          Chieftain
## 5   88    6.28           Atlantic
## 6   74    5.28           Kennebec
## 7   65    4.64            FL 1533
## 8   58    4.14     Coastal Russet
## 9   51    3.64            Snowden
## 10  27    1.93            Mystere
## 11  26    1.86         AC Belmont
## 12  25    1.78         Yukon Gold
## 13  24    1.71            Shepody
## 14  23    1.64            Aquilon
## 15  19    1.36     Russet Burbank
## 16  18    1.28            Vivaldi
## 17  17    1.21            Andover
## 18  17    1.21             Estima
## 19  17    1.21            Norland
## 20  16    1.14         Pommerelle
## 21  11    0.79               Reba
## 22   9    0.64        Bijou Rouge
## 23   7    0.50              Argos
## 24   7    0.50 Dark Red Chieftain
## 25   7    0.50               Pike
## 26   6    0.43               Roko
## 27   6    0.43             Waneta
## 28   5    0.36         AC Chaleur
## 29   5    0.36           Amandine
## 30   5    0.36           Prospect
## 31   5    0.36          Red Maria
## 32   5    0.36     Russet Norkota
## 33   4    0.29            Lanorma
## 34   4    0.29          Red Cloud
## 35   4    0.29             W 1386
## 36   3    0.21           Carolina
## 37   3    0.21           Nordonna
## 38   3    0.21              Sifra
## 39   2    0.14              Ambra
## 40   2    0.14             Kanona
## 41   2    0.14         Keuka Gold
## 42   2    0.14             Lamoka
## 43   1    0.07    Frontier Russet
## 44   1    0.07            Harmony
## 45   1    0.07             Krantz</code></pre>
<p>Some cultivars are well represented, like Goldrush and Superior. Let’s compute numbers of cultivars and trials for high yielders.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">data.frame</span>(<span class="dt">nbr_cultivars =</span> <span class="kw">n_distinct</span>(highYielders_df<span class="op">$</span>Cultivar, <span class="dt">na.rm =</span> T), 
           <span class="dt">nbr_trials =</span> <span class="kw">n_distinct</span>(highYielders_df<span class="op">$</span>NoEssai, <span class="dt">na.rm =</span> T))</code></pre></div>
<pre><code>##   nbr_cultivars nbr_trials
## 1            45        149</code></pre>
<p>A table with cultivars, maturity classes and median clr values (<em>i.e.</em>, Centroids).</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">highYielders_clr &lt;-<span class="st"> </span>highYielders_df <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">group_by</span>(Cultivar, Maturity5) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">select</span>(Cultivar, Maturity5, <span class="kw">starts_with</span>(<span class="st">&quot;clr&quot;</span>)) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">summarise_all</span>(<span class="kw">list</span>(median))
highYielders_clr</code></pre></div>
<pre><code>## # A tibble: 45 x 8
## # Groups:   Cultivar [45]
##    Cultivar    Maturity5        clr_N clr_P clr_K clr_Mg clr_Ca clr_Fv
##    &lt;fct&gt;       &lt;fct&gt;            &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;
##  1 AC Belmont  early            0.698 -2.00 0.662  -1.62 -1.12    3.46
##  2 AC Chaleur  early            0.688 -1.98 0.352  -1.54 -1.02    3.50
##  3 Amandine    mid-season       0.526 -2.30 0.525  -1.59 -0.680   3.51
##  4 Ambra       mid-season       0.713 -1.98 0.275  -1.39 -1.08    3.46
##  5 Andover     early mid-season 0.812 -2.17 0.749  -2.28 -0.808   3.61
##  6 Aquilon     mid-season       0.783 -1.86 0.387  -1.83 -0.901   3.48
##  7 Argos       late             0.767 -1.77 0.570  -1.70 -1.28    3.43
##  8 Atlantic    mid-season       0.784 -1.87 0.155  -1.50 -1.09    3.56
##  9 Bijou Rouge early            0.942 -1.93 0.563  -1.93 -1.12    3.61
## 10 Carolina    early            0.598 -2.19 0.131  -1.34 -0.837   3.63
## # ... with 35 more rows</code></pre>
<p>Identify outliers with a criterion of 0.975 by cultivar, if cultivars contain at leat 20 rows. If less than 20 rows, all rows are kept. The new data frame is used for discriminant analysis <code>lda_df</code>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">highYielders_df_IO &lt;-<span class="st"> </span>highYielders_df <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">group_by</span>(Cultivar) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">select</span>(<span class="kw">starts_with</span>(<span class="st">&quot;clr&quot;</span>)) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">do</span>({
    <span class="cf">if</span> (<span class="kw">nrow</span>(.) <span class="op">&lt;</span><span class="st"> </span><span class="dv">20</span>) {
      IO =<span class="st"> </span><span class="kw">rep</span>(<span class="dv">1</span>, <span class="kw">nrow</span>(.))
    } <span class="cf">else</span> {
      IO =<span class="st"> </span><span class="kw">sign1</span>(.[,<span class="op">-</span><span class="dv">1</span>], <span class="dt">qcrit=</span><span class="fl">0.975</span>)<span class="op">$</span>wfinal01
    }
    <span class="kw">cbind</span>(.,IO)
  })

lda_df &lt;-<span class="st"> </span>highYielders_df_IO <span class="op">%&gt;%</span>
<span class="st">              </span><span class="kw">filter</span>(IO <span class="op">==</span><span class="st"> </span><span class="dv">1</span>) <span class="op">%&gt;%</span>
<span class="st">              </span><span class="kw">droplevels</span>()
<span class="kw">nrow</span>(lda_df)</code></pre></div>
<pre><code>## [1] 1244</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">lda_df <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">head</span>()</code></pre></div>
<pre><code>## # A tibble: 6 x 8
## # Groups:   Cultivar [1]
##   Cultivar   clr_N clr_P clr_K clr_Mg clr_Ca clr_Fv    IO
##   &lt;fct&gt;      &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt;
## 1 AC Belmont 0.708 -2.32 0.718  -1.75 -0.813   3.45     1
## 2 AC Belmont 0.610 -2.35 0.730  -1.81 -0.739   3.56     1
## 3 AC Belmont 0.727 -1.87 0.724  -1.68 -1.34    3.44     1
## 4 AC Belmont 0.752 -1.89 0.657  -1.66 -1.28    3.42     1
## 5 AC Belmont 0.610 -2.01 0.664  -1.59 -1.14    3.46     1
## 6 AC Belmont 0.723 -1.96 0.616  -1.59 -1.22    3.42     1</code></pre>
<p>Axis reduction with LDA Linear Discriminant Analysis</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">lda_df<span class="op">$</span>Cultivar &lt;-<span class="st"> </span><span class="kw">factor</span>(lda_df<span class="op">$</span>Cultivar)
pca_fol &lt;-<span class="st"> </span><span class="kw">dudi.pca</span>(lda_df[clr_no], <span class="dt">scannf =</span> <span class="ot">FALSE</span>, <span class="dt">scale =</span> <span class="ot">FALSE</span>)
lda_fol &lt;-<span class="st"> </span><span class="kw">discrimin</span>(<span class="dt">dudi =</span> pca_fol, <span class="dt">fac =</span> <span class="kw">factor</span>(lda_df<span class="op">$</span>Cultivar), <span class="dt">scannf =</span> <span class="ot">FALSE</span>)
lda_fol_score =<span class="st"> </span>lda_fol<span class="op">$</span>li
lda_fol_loading =<span class="st"> </span>lda_fol<span class="op">$</span>fa</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">lda_fol_group =<span class="st"> </span>lda_df<span class="op">$</span>Cultivar
n_cultivar =<span class="st"> </span><span class="kw">table</span>(lda_df<span class="op">$</span>Cultivar)
<span class="co"># Do not schow Cultivars whose number of occurrences is &lt; 5</span>
n_filter &lt;-<span class="st"> </span>lda_fol_group <span class="op">%in%</span><span class="st"> </span><span class="kw">names</span>(n_cultivar[n_cultivar <span class="op">&gt;=</span><span class="st"> </span><span class="dv">5</span>]) 
filter_cultivars &lt;-<span class="st"> </span><span class="kw">names</span>(n_cultivar[n_cultivar <span class="op">&gt;=</span><span class="st"> </span><span class="dv">5</span>])
lda_df_filter &lt;-<span class="st"> </span>lda_df[n_filter, ]</code></pre></div>
<p>The distance biplot, a first view.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">options</span>(<span class="dt">repr.plot.width =</span> <span class="dv">6</span>, <span class="dt">repr.plot.height =</span> <span class="dv">6</span>)
<span class="kw">plot_lda</span>(<span class="dt">score=</span>lda_fol_score[n_filter, ],
         <span class="dt">loading=</span>lda_fol_loading[n_filter, ],
         <span class="dt">group =</span> lda_fol_group[n_filter],
         <span class="dt">ell_dev=</span><span class="ot">FALSE</span>, 
         <span class="dt">ell_err=</span> <span class="ot">FALSE</span>, <span class="co">#TRUE, </span>
         <span class="dt">scale_load =</span> <span class="fl">0.5</span>,
         <span class="dt">level=</span><span class="fl">0.95</span>,
         <span class="dt">legend=</span><span class="ot">FALSE</span>,
         <span class="dt">label=</span><span class="ot">TRUE</span>,
         <span class="dt">transparency=</span><span class="fl">0.3</span>, <span class="dt">xlim =</span> <span class="kw">c</span>(<span class="op">-</span><span class="fl">2.5</span>, <span class="dv">2</span>), <span class="dt">ylim =</span> <span class="kw">c</span>(<span class="op">-</span><span class="fl">3.5</span>, <span class="fl">3.5</span>),
         <span class="dt">points=</span>F)</code></pre></div>
<div class="figure" style="text-align: center"><span id="fig:d-biplot-1"></span>
<img src="2019_Bookdown_files/figure-html/d-biplot-1-1.png" alt="Discriminant distance biplot of potato cultivars." width="100%" />
<p class="caption">
Figure 2.1: Discriminant distance biplot of potato cultivars.
</p>
</div>
<p>K-means clustering using clr centroïds for high yielders</p>
<p>The next data frame is the same as <code>highYielders_clr</code> without maturity classes.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">highYieldersCentroids &lt;-<span class="st"> </span>highYielders_df <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">group_by</span>(Cultivar) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">select</span>(<span class="kw">starts_with</span>(<span class="st">&quot;clr&quot;</span>)) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">summarise_all</span>(<span class="kw">list</span>(median))</code></pre></div>
<p>We use <code>Calinski-Harabasz (1974) criterion (package vegan)</code> for clustering.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">set.seed</span>(<span class="dv">194447</span>)
highYieldersKmeans &lt;-<span class="st"> </span><span class="kw">cascadeKM</span>(highYieldersCentroids[, <span class="op">-</span><span class="dv">1</span>], <span class="dt">inf.gr =</span> <span class="dv">3</span>, <span class="dt">sup.gr =</span> <span class="dv">8</span>, <span class="dt">criterion =</span> <span class="st">&quot;calinski&quot;</span>)</code></pre></div>
<p>Plot K-means clustering results.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">options</span>(<span class="dt">repr.plot.width =</span> <span class="dv">6</span>, <span class="dt">repr.plot.height =</span> <span class="dv">4</span>)
<span class="kw">plot</span>(highYieldersKmeans) </code></pre></div>
<div class="figure" style="text-align: center"><span id="fig:clustering"></span>
<img src="2019_Bookdown_files/figure-html/clustering-1.png" alt="K-means partitions comparison (calinski criterion)." width="100%" />
<p class="caption">
Figure 2.2: K-means partitions comparison (calinski criterion).
</p>
</div>
<p>The red dot of the right hand side graph shows 4 optimal clustering partitions. Check the differnt partitions data frame.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">highYieldersKmeans<span class="op">$</span>partition <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">head</span>()</code></pre></div>
<pre><code>##   3 groups 4 groups 5 groups 6 groups 7 groups 8 groups
## 1        3        3        4        3        7        3
## 2        1        2        5        4        4        1
## 3        2        1        1        5        6        2
## 4        1        2        5        4        4        7
## 5        3        4        3        6        2        5
## 6        3        4        3        3        7        3</code></pre>
<p>Consider <code>4 groups</code> from clustering according to <code>calinski criterion</code>, this corresponds to the column 2 or use <strong>4 groups</strong> as column name directly, and add it up to the previous data frame.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">highYieldersCentroids<span class="op">$</span>kgroup &lt;-<span class="st"> </span>highYieldersKmeans<span class="op">$</span>partition[, <span class="st">&quot;4 groups&quot;</span>]</code></pre></div>
<p>Compute discriminant scores centroïdes for cultivars.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">lda_centroids &lt;-<span class="st"> </span>lda_fol_score <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">group =</span> lda_fol_group) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">group_by</span>(group) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">summarise_all</span>(<span class="kw">list</span>(mean))</code></pre></div>
<p>Plot Cultivar groups in LDA with a custom function.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">options</span>(<span class="dt">repr.plot.width =</span> <span class="dv">6</span>, <span class="dt">repr.plot.height =</span> <span class="dv">6</span>)
<span class="co">#png(&quot;images/clustering.png&quot;, width=3000, height=1400, res = 300)</span>
<span class="kw">plot_lda</span>(<span class="dt">score=</span>lda_fol_score[n_filter, ],
         <span class="dt">loading=</span>lda_fol_loading[n_filter, ],
         <span class="dt">group =</span> lda_fol_group[n_filter],
         <span class="dt">ell_dev=</span><span class="ot">FALSE</span>, 
         <span class="dt">ell_err=</span> <span class="ot">FALSE</span>, <span class="co">#TRUE, </span>
         <span class="dt">scale_load =</span> <span class="fl">0.4</span>,
         <span class="dt">level=</span><span class="fl">0.95</span>,
         <span class="dt">legend=</span><span class="ot">FALSE</span>,
         <span class="dt">label=</span><span class="ot">TRUE</span>,
         <span class="dt">transparency=</span><span class="fl">0.4</span>, <span class="dt">xlim =</span> <span class="kw">c</span>(<span class="op">-</span><span class="fl">2.5</span>, <span class="dv">2</span>), <span class="dt">ylim =</span> <span class="kw">c</span>(<span class="op">-</span><span class="fl">3.5</span>, <span class="fl">3.5</span>),
         <span class="dt">points=</span>F)

coll =<span class="st"> </span><span class="kw">factor</span>(highYieldersCentroids[highYieldersCentroids<span class="op">$</span>Cultivar <span class="op">%in%</span><span class="st"> </span>filter_cultivars, <span class="st">&#39;kgroup&#39;</span>][[<span class="dv">1</span>]])

<span class="co"># remove the cultivar column</span>
<span class="kw">points</span>(lda_centroids[lda_centroids<span class="op">$</span>group <span class="op">%in%</span><span class="st"> </span>filter_cultivars, <span class="kw">c</span>(<span class="st">&#39;DS1&#39;</span>, <span class="st">&#39;DS2&#39;</span>)], 
       <span class="dt">pch =</span> <span class="dv">19</span>,
       <span class="dt">col =</span> coll, <span class="co"># colours dots for groups or clusters.</span>
       <span class="dt">cex =</span> <span class="fl">0.9</span>)

<span class="kw">legend</span>(<span class="op">-</span><span class="fl">2.5</span>, <span class="dv">3</span>, 
       <span class="dt">legend =</span> <span class="kw">paste</span>(<span class="kw">rep</span>(<span class="st">&#39;cluster&#39;</span>, <span class="kw">nlevels</span>(coll)), <span class="kw">as.numeric</span>(<span class="kw">levels</span>(coll))), 
       <span class="dt">pch =</span> <span class="dv">19</span>,
       <span class="dt">col =</span> <span class="kw">unique</span>(coll),  
       <span class="dt">cex =</span> <span class="fl">0.9</span>)</code></pre></div>
<div class="figure" style="text-align: center"><span id="fig:d-biplot-2"></span>
<img src="2019_Bookdown_files/figure-html/d-biplot-2-1.png" alt="Discriminant distance biplot of potato cultivars showing ionomics groups." width="100%" />
<p class="caption">
Figure 2.3: Discriminant distance biplot of potato cultivars showing ionomics groups.
</p>
</div>
<p>It’s a bit difficult to colour cultivar names in the plot with the custom function. Use functions from packages <code>ggplot2</code>, <code>ggrepel</code> and <code>plotly</code> instead. The package <code>ggplot2</code> is already loaded with <code>tidyverse</code>. New data frames are created with useful variables.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(<span class="st">&quot;ggrepel&quot;</span>)
<span class="kw">library</span>(<span class="st">&quot;plotly&quot;</span>)

cultivars_filtre &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">Cultivar =</span> filter_cultivars, <span class="dt">i_group=</span>coll)

df &lt;-<span class="st"> </span><span class="kw">data.frame</span>(
    <span class="dt">score =</span> lda_fol_score[n_filter, ],
    <span class="dt">loadings =</span> lda_fol_loading[n_filter,],
    <span class="dt">Cultivar =</span> lda_fol_group[n_filter]
                )
df &lt;-<span class="st"> </span>df <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">left_join</span>(cultivars_filtre, <span class="dt">by=</span><span class="st">&quot;Cultivar&quot;</span>)
df <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">head</span>()</code></pre></div>
<pre><code>##     score.DS1 score.DS2 loadings.DS1 loadings.DS2   Cultivar i_group
## 1 -0.66902049 1.2508355  -1.80452082   -0.8166182 AC Belmont       3
## 2 -0.55105954 0.8275579   0.33929124    1.1542930 AC Belmont       3
## 3 -0.40168546 0.9054121  -1.96450084    2.3374270 AC Belmont       3
## 4 -0.30280178 0.9424118   2.28179831    0.8360123 AC Belmont       3
## 5  0.10410599 1.0195041  -0.04728401    1.8852473 AC Belmont       3
## 6 -0.02339004 0.9371925   1.19521611   -5.3963614 AC Belmont       3</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">centroids =<span class="st"> </span>lda_centroids[lda_centroids<span class="op">$</span>group <span class="op">%in%</span><span class="st"> </span>filter_cultivars, ]
<span class="kw">names</span>(centroids)[<span class="kw">match</span>(<span class="st">&quot;group&quot;</span>, <span class="kw">names</span>(centroids))] &lt;-<span class="st"> &quot;Cultivar&quot;</span>
centroids &lt;-<span class="st"> </span>centroids <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">left_join</span>(cultivars_filtre, <span class="dt">by=</span><span class="st">&quot;Cultivar&quot;</span>)
centroids <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">head</span>()</code></pre></div>
<pre><code>## # A tibble: 6 x 4
##   Cultivar       DS1   DS2 i_group
##   &lt;chr&gt;        &lt;dbl&gt; &lt;dbl&gt; &lt;fct&gt;  
## 1 AC Belmont  0.0326 0.787 3      
## 2 AC Chaleur  0.755  0.257 2      
## 3 Amandine    0.636  0.989 1      
## 4 Andover    -1.90   0.138 4      
## 5 Aquilon    -0.140  0.302 4      
## 6 Argos      -0.119  0.677 3</code></pre>
<p>Plot with ggplot2</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co">#png(&quot;data/clustering.png&quot;, width=3000, height=1400, res = 300)</span>
<span class="kw">options</span>(<span class="dt">repr.plot.width =</span> <span class="dv">9</span>, <span class="dt">repr.plot.height =</span> <span class="dv">9</span>)
g &lt;-<span class="st"> </span><span class="kw">ggplot</span>(centroids, <span class="kw">aes</span>(DS1, DS2, <span class="dt">label =</span> Cultivar, <span class="dt">col=</span>i_group)) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_text_repel</span>() <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_point</span>(<span class="dt">alpha =</span> <span class="fl">0.5</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">theme_classic</span>(<span class="dt">base_size =</span> <span class="dv">12</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">scale_color_manual</span>(<span class="dt">values=</span><span class="kw">c</span>(<span class="st">&quot;red&quot;</span>, <span class="st">&quot;magenta&quot;</span>, <span class="st">&quot;blue&quot;</span>, <span class="st">&quot;black&quot;</span>)) <span class="op">+</span><span class="st"> </span>
<span class="st">  </span><span class="kw">theme</span>(<span class="dt">axis.text=</span><span class="kw">element_text</span>(<span class="dt">size=</span><span class="dv">12</span>)) <span class="op">+</span>
<span class="st">  </span><span class="kw">theme</span>(<span class="dt">text=</span><span class="kw">element_text</span>(<span class="dt">family=</span><span class="st">&quot;Arial&quot;</span>, <span class="dt">face=</span><span class="st">&quot;bold&quot;</span>, <span class="dt">size=</span><span class="dv">12</span>))

<span class="co"># Add discriminant loadings using geom_segment and arrow</span>
x=<span class="dv">0</span>; y=<span class="dv">0</span>; labels =<span class="st"> </span><span class="kw">c</span>(clr_no, <span class="kw">rep</span>(<span class="ot">NA</span>, <span class="kw">nrow</span>(df)<span class="op">-</span><span class="kw">length</span>(clr_no)))
g <span class="op">+</span><span class="st"> </span><span class="kw">geom_segment</span>(<span class="dt">data=</span>df, <span class="dt">mapping=</span><span class="kw">aes</span>(<span class="dt">x=</span>x, <span class="dt">y=</span>y, <span class="dt">xend=</span>x<span class="op">+</span>loadings.DS1, <span class="dt">yend=</span>y<span class="op">+</span>loadings.DS2), 
                 <span class="dt">arrow=</span><span class="kw">arrow</span>(), <span class="dt">size =</span> <span class="dv">1</span>, <span class="dt">color=</span><span class="st">&quot;grey80&quot;</span>) <span class="op">+</span><span class="st"> </span>
<span class="st">    </span><span class="kw">geom_text</span>(<span class="dt">data=</span>df, <span class="dt">mapping=</span><span class="kw">aes</span>(<span class="dt">x=</span>loadings.DS1, <span class="dt">y=</span>loadings.DS2, <span class="dt">label=</span>labels), <span class="dt">size=</span><span class="dv">5</span>, <span class="dt">color=</span><span class="st">&quot;black&quot;</span>) <span class="op">+</span>
<span class="st">    </span><span class="kw">geom_hline</span>(<span class="dt">yintercept=</span><span class="dv">0</span>, <span class="dt">color=</span><span class="st">&quot;black&quot;</span>, <span class="dt">linetype=</span><span class="dv">2</span>) <span class="op">+</span>
<span class="st">    </span><span class="kw">geom_vline</span>(<span class="dt">mapping=</span><span class="kw">aes</span>(<span class="dt">xintercept=</span><span class="dv">0</span>), <span class="dt">color=</span><span class="st">&quot;black&quot;</span>, <span class="dt">linetype=</span><span class="dv">2</span>) <span class="op">+</span><span class="st"> </span>
<span class="st">    </span><span class="kw">theme</span>(<span class="dt">axis.line=</span><span class="kw">element_blank</span>())</code></pre></div>
<div class="figure" style="text-align: center"><span id="fig:gg-biplot"></span>
<img src="2019_Bookdown_files/figure-html/gg-biplot-1.png" alt="Discriminant biplot and cluster analysis result of potato cultivars." width="100%" />
<p class="caption">
Figure 2.4: Discriminant biplot and cluster analysis result of potato cultivars.
</p>
</div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co">#ggsave(&quot;images/cultivar_clust.png&quot;, width=10, height=8, dpi = 300)</span></code></pre></div>
<p>Push Cultivars yield cut-off and ionomics groups in the data frame.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">ionomicGroup &lt;-<span class="st"> </span><span class="kw">data.frame</span>(lda_centroids[, <span class="dv">1</span>], 
                           <span class="dt">ionomicGroup =</span> <span class="kw">factor</span>(highYieldersKmeans<span class="op">$</span>partition[, <span class="st">&quot;4 groups&quot;</span>]))
<span class="kw">colnames</span>(ionomicGroup)[<span class="kw">colnames</span>(ionomicGroup)<span class="op">==</span><span class="st">&quot;group&quot;</span>] &lt;-<span class="st"> &quot;Cultivar&quot;</span>
cutQ &lt;-<span class="st"> </span>cutQ[<span class="op">-</span><span class="dv">1</span>, ] <span class="co"># to discard missing cultivars</span>
<span class="kw">colnames</span>(cutQ)[<span class="kw">which</span>(<span class="kw">names</span>(cutQ) <span class="op">==</span><span class="st"> &quot;rv_cut&quot;</span>)] &lt;-<span class="st"> &quot;yieldCutoff&quot;</span>
cutQ_ig &lt;-<span class="st"> </span>cutQ <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">left_join</span>(ionomicGroup, <span class="dt">by =</span> <span class="st">&quot;Cultivar&quot;</span>)

fol_df &lt;-<span class="st"> </span>fol_df <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">left_join</span>(<span class="dt">y =</span> cutQ_ig, <span class="dt">by =</span> <span class="st">&#39;Cultivar&#39;</span>) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">select</span>(<span class="op">-</span>rv_cut)</code></pre></div>
<p>Processing data for Machine Learning <code>dfml</code>, saved as <code>data_ionome.csv</code>. Exctract usefull columns from <code>fol_df</code>. Conserve only `complete cases.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">dfml &lt;-<span class="st"> </span>fol_df <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">isNA =</span> <span class="kw">apply</span>(.[<span class="kw">c</span>(clr_no, cult_yield)], <span class="dv">1</span>, anyNA)) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">is10pcf =</span> AnalyseFoliaireStade <span class="op">==</span><span class="st"> &quot;10% fleur&quot;</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">filter</span>(<span class="op">!</span>isNA <span class="op">&amp;</span><span class="st"> </span>is10pcf <span class="op">&amp;</span><span class="st"> </span>NoEssai <span class="op">!=</span><span class="st"> &quot;2&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">select</span>(<span class="kw">one_of</span>(<span class="kw">c</span>(keys_col, clr_no, cult_yield, <span class="st">&#39;yieldClass&#39;</span>, <span class="st">&#39;ionomicGroup&#39;</span>))) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>AnalyseFoliaireStade) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">droplevels</span>() <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">filter</span>(<span class="kw">complete.cases</span>(.))
<span class="kw">nrow</span>(dfml)</code></pre></div>
<pre><code>## [1] 3369</code></pre>
<p>Backup</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">write.csv2</span>(dfml, <span class="st">&quot;data/data_ionome.csv&quot;</span>)</code></pre></div>
<p>Linear mixed effect modeling of yield relative to the <code>ionome*ionomicGroup</code> interaction (extraction of the interactions coefficients).</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(<span class="st">&quot;nlme&quot;</span>)
<span class="kw">source</span>(<span class="st">&quot;data/functions.R&quot;</span>) <span class="co"># contains a costum r-square function</span>
dfml<span class="op">$</span>Cultivar &lt;-<span class="st"> </span><span class="kw">factor</span>(dfml<span class="op">$</span>Cultivar)
dfml<span class="op">$</span>Maturity5 &lt;-<span class="st"> </span><span class="kw">relevel</span>(dfml<span class="op">$</span>Maturity5, <span class="dt">ref=</span><span class="st">&quot;late&quot;</span>)
dfml<span class="op">$</span>Cultivar &lt;-<span class="st"> </span><span class="kw">relevel</span>(dfml<span class="op">$</span>Cultivar, <span class="dt">ref=</span><span class="st">&quot;Goldrush&quot;</span>)
dfml<span class="op">$</span>NoEssai &lt;-<span class="st"> </span><span class="kw">factor</span>(dfml<span class="op">$</span>NoEssai)
<span class="kw">colnames</span>(dfml)[<span class="kw">colnames</span>(dfml)<span class="op">==</span><span class="st">&quot;ionomicGroup&quot;</span>] &lt;-<span class="st"> &quot;group_i&quot;</span>
dfml<span class="op">$</span>group_i &lt;-<span class="st"> </span><span class="kw">factor</span>(dfml<span class="op">$</span>group_i)

clr_no &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;clr_N&quot;</span>, <span class="st">&quot;clr_P&quot;</span>, <span class="st">&quot;clr_K&quot;</span>, <span class="st">&quot;clr_Ca&quot;</span>, <span class="st">&quot;clr_Mg&quot;</span>, <span class="st">&quot;clr_Fv&quot;</span>)
clrNo &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;clrN&quot;</span>, <span class="st">&quot;clrP&quot;</span>, <span class="st">&quot;clrK&quot;</span>, <span class="st">&quot;clrCa&quot;</span>, <span class="st">&quot;clrMg&quot;</span>, <span class="st">&quot;clrFv&quot;</span>) <span class="co"># for plot</span>
<span class="kw">colnames</span>(dfml)[<span class="kw">which</span>(<span class="kw">names</span>(dfml) <span class="op">%in%</span><span class="st"> </span>clr_no)] &lt;-<span class="st"> </span>clrNo</code></pre></div>
<p>Scale clr coordinates</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">dfml.sc &lt;-<span class="st"> </span>dfml  <span class="co"># copy</span>
dfml.sc[, clrNo] &lt;-<span class="st"> </span><span class="kw">apply</span>(dfml.sc[, clrNo], <span class="dv">2</span>, scale)</code></pre></div>
<p>Fit linear mixed model.</p>
<p>Discard the filling value to deal with singularity problem.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">used_clr =<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;clrN&quot;</span>, <span class="st">&quot;clrP&quot;</span>, <span class="st">&quot;clrK&quot;</span>, <span class="st">&quot;clrCa&quot;</span>, <span class="st">&quot;clrMg&quot;</span>) <span class="co"># without &quot;clr_Fv&quot;</span>
lmm &lt;-<span class="st"> </span><span class="kw">lme</span>(RendVendable <span class="op">~</span><span class="st"> </span>(clrN <span class="op">+</span><span class="st"> </span>clrP <span class="op">+</span><span class="st"> </span>clrK <span class="op">+</span><span class="st"> </span>clrCa <span class="op">+</span><span class="st"> </span>clrMg)<span class="op">:</span>group_i, 
            <span class="dt">data=</span>dfml.sc, 
            <span class="dt">random=</span> <span class="op">~</span><span class="dv">1</span><span class="op">|</span>NoEssai)

pseudoR2 =<span class="st"> </span><span class="kw">rsq</span>(dfml.sc<span class="op">$</span>RendVendable, <span class="kw">predict</span>(lmm))
pseudoR2</code></pre></div>
<pre><code>## [1] 0.7400044</code></pre>
<p>Extract the interactions coefficients and their p-values (pv) matrix:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">pv &lt;-<span class="st"> </span><span class="kw">summary</span>(lmm)<span class="op">$</span>tTable[<span class="op">-</span><span class="dv">1</span>,]
pv</code></pre></div>
<pre><code>##                   Value Std.Error   DF   t-value      p-value
## clrN:group_i1  6.645143 2.1649322 3150  3.069446 2.162828e-03
## clrN:group_i2  9.007241 0.6874520 3150 13.102357 3.132439e-38
## clrN:group_i3  6.949603 1.4852004 3150  4.679236 3.000809e-06
## clrN:group_i4  3.195431 0.3866881 3150  8.263587 2.057744e-16
## clrP:group_i1  6.795965 2.7092875 3150  2.508396 1.217794e-02
## clrP:group_i2  8.449904 0.8658023 3150  9.759623 3.449225e-22
## clrP:group_i3  9.003016 2.2037071 3150  4.085396 4.509847e-05
## clrP:group_i4  1.618988 0.4610944 3150  3.511187 4.523723e-04
## clrK:group_i1  7.646919 2.8537539 3150  2.679600 7.409365e-03
## clrK:group_i2  9.272317 0.9305423 3150  9.964423 4.767161e-23
## clrK:group_i3  3.434110 2.7288719 3150  1.258436 2.083275e-01
## clrK:group_i4  1.740554 0.6261693 3150  2.779686 5.473444e-03
## clrCa:group_i1 7.936266 2.4551030 3150  3.232559 1.239518e-03
## clrCa:group_i2 9.912541 0.9136017 3150 10.849958 5.942979e-27
## clrCa:group_i3 7.201106 1.9860081 3150  3.625920 2.924953e-04
## clrCa:group_i4 3.230313 0.5834249 3150  5.536811 3.333127e-08
## clrMg:group_i1 7.332749 2.7405918 3150  2.675608 7.497989e-03
## clrMg:group_i2 7.389987 0.8650038 3150  8.543300 2.000749e-17
## clrMg:group_i3 4.020082 2.1795290 3150  1.844473 6.520812e-02
## clrMg:group_i4 1.114686 0.4414678 3150  2.524955 1.162000e-02</code></pre>
<p>Also extract their confident intervals, and process data for the plot.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">interval &lt;-<span class="st"> </span><span class="kw">tibble</span>(<span class="dt">Estimate =</span> <span class="kw">intervals</span>(lmm)<span class="op">$</span>fixed[<span class="op">-</span><span class="dv">1</span>, <span class="dv">2</span>],
                    <span class="dt">LL =</span> <span class="kw">intervals</span>(lmm)<span class="op">$</span>fixed[<span class="op">-</span><span class="dv">1</span>, <span class="dv">1</span>], 
                    <span class="dt">UL =</span> <span class="kw">intervals</span>(lmm)<span class="op">$</span>fixed[<span class="op">-</span><span class="dv">1</span>, <span class="dv">3</span>]) 

interval<span class="op">$</span>variable &lt;-<span class="st"> </span><span class="kw">rep</span>(<span class="st">&#39;NA&#39;</span>, <span class="kw">nrow</span>(interval))
interval<span class="op">$</span>variable &lt;-<span class="st"> </span><span class="kw">rownames</span>(<span class="kw">intervals</span>(lmm)<span class="op">$</span>fixed)[<span class="op">-</span><span class="dv">1</span>]
interval<span class="op">$</span>ionomic_group &lt;-<span class="st"> </span><span class="kw">rep</span>(<span class="kw">paste</span>(<span class="st">&quot;group&quot;</span>, <span class="dv">1</span><span class="op">:</span><span class="kw">nlevels</span>(dfml<span class="op">$</span>group_i)), <span class="kw">length</span>(clrNo)<span class="op">-</span><span class="dv">1</span>)
interval<span class="op">$</span>used_clr &lt;-<span class="st"> </span><span class="kw">rep</span>(used_clr, <span class="dt">each =</span> <span class="kw">nlevels</span>(dfml<span class="op">$</span>group_i))

interval<span class="op">$</span>pvalue &lt;-<span class="st"> </span>pv[,<span class="st">&quot;p-value&quot;</span>]
interval<span class="op">$</span>is_significant =<span class="st"> </span><span class="kw">ifelse</span>(interval<span class="op">$</span>pvalue <span class="op">&lt;=</span><span class="st"> </span><span class="fl">0.05</span>,
                                      <span class="st">&#39;P &lt; 0.05&#39;</span>,
                                      <span class="st">&#39;P &gt; 0.05&#39;</span>)
interval</code></pre></div>
<pre><code>## # A tibble: 20 x 8
##    Estimate     LL    UL variable ionomic_group used_clr   pvalue
##       &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt; &lt;chr&gt;    &lt;chr&gt;         &lt;chr&gt;       &lt;dbl&gt;
##  1     6.65  2.40  10.9  clrN:gr~ group 1       clrN     2.16e- 3
##  2     9.01  7.66  10.4  clrN:gr~ group 2       clrN     3.13e-38
##  3     6.95  4.04   9.86 clrN:gr~ group 3       clrN     3.00e- 6
##  4     3.20  2.44   3.95 clrN:gr~ group 4       clrN     2.06e-16
##  5     6.80  1.48  12.1  clrP:gr~ group 1       clrP     1.22e- 2
##  6     8.45  6.75  10.1  clrP:gr~ group 2       clrP     3.45e-22
##  7     9.00  4.68  13.3  clrP:gr~ group 3       clrP     4.51e- 5
##  8     1.62  0.715  2.52 clrP:gr~ group 4       clrP     4.52e- 4
##  9     7.65  2.05  13.2  clrK:gr~ group 1       clrK     7.41e- 3
## 10     9.27  7.45  11.1  clrK:gr~ group 2       clrK     4.77e-23
## 11     3.43 -1.92   8.78 clrK:gr~ group 3       clrK     2.08e- 1
## 12     1.74  0.513  2.97 clrK:gr~ group 4       clrK     5.47e- 3
## 13     7.94  3.12  12.8  clrCa:g~ group 1       clrCa    1.24e- 3
## 14     9.91  8.12  11.7  clrCa:g~ group 2       clrCa    5.94e-27
## 15     7.20  3.31  11.1  clrCa:g~ group 3       clrCa    2.92e- 4
## 16     3.23  2.09   4.37 clrCa:g~ group 4       clrCa    3.33e- 8
## 17     7.33  1.96  12.7  clrMg:g~ group 1       clrMg    7.50e- 3
## 18     7.39  5.69   9.09 clrMg:g~ group 2       clrMg    2.00e-17
## 19     4.02 -0.253  8.29 clrMg:g~ group 3       clrMg    6.52e- 2
## 20     1.11  0.249  1.98 clrMg:g~ group 4       clrMg    1.16e- 2
## # ... with 1 more variable: is_significant &lt;chr&gt;</code></pre>
<p>Plot with ggplot2.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">options</span>(<span class="dt">repr.plot.width =</span> <span class="dv">5</span>, <span class="dt">repr.plot.height =</span> <span class="dv">5</span>)
gg &lt;-<span class="st"> </span><span class="kw">ggplot</span>(<span class="dt">data =</span> interval, <span class="dt">mapping =</span> <span class="kw">aes</span>(<span class="dt">x =</span> Estimate, <span class="dt">y =</span> used_clr, <span class="dt">color=</span>is_significant)) <span class="op">+</span>
<span class="st">         </span><span class="kw">facet_grid</span>(ionomic_group <span class="op">~</span><span class="st"> </span>.) <span class="op">+</span><span class="st"> </span><span class="co">#, scales = &#39;free&#39;, space = &#39;free&#39;) +</span>
<span class="st">         </span><span class="kw">geom_vline</span>(<span class="dt">xintercept =</span> <span class="dv">0</span>, <span class="dt">lty =</span> <span class="dv">2</span>) <span class="op">+</span>
<span class="st">         </span><span class="kw">geom_segment</span>(<span class="dt">mapping =</span> <span class="kw">aes</span>(<span class="dt">x =</span> LL, <span class="dt">xend =</span> UL, <span class="dt">y =</span> used_clr, <span class="dt">yend =</span> used_clr)) <span class="op">+</span>
<span class="st">         </span><span class="kw">geom_point</span>() <span class="op">+</span>
<span class="st">         </span><span class="co">#scale_color_grey(start=.1, end=0) +</span>
<span class="st">         </span><span class="kw">labs</span>(<span class="dt">x =</span> <span class="st">&quot;Coefficient&quot;</span>, <span class="dt">y =</span> <span class="st">&quot;&quot;</span>) <span class="op">+</span>
<span class="st">         </span><span class="kw">theme_bw</span>() <span class="op">+</span>
<span class="st">         </span><span class="kw">theme</span>(<span class="dt">text=</span><span class="kw">element_text</span>(<span class="dt">family=</span><span class="st">&quot;Arial&quot;</span>, <span class="dt">face=</span><span class="st">&quot;bold&quot;</span>, <span class="dt">size=</span><span class="dv">12</span>))
gg <span class="op">+</span><span class="st"> </span><span class="kw">theme</span>(<span class="dt">legend.title =</span> <span class="kw">element_blank</span>())<span class="co">#, legend.position = &#39;bottom&#39;)</span></code></pre></div>
<div class="figure" style="text-align: center"><span id="fig:coefficients"></span>
<img src="2019_Bookdown_files/figure-html/coefficients-1.png" alt="Effect of ionome perturbation on marketable yield as illustrated by a linear mixed effect model." width="100%" />
<p class="caption">
Figure 2.5: Effect of ionome perturbation on marketable yield as illustrated by a linear mixed effect model.
</p>
</div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co">#ggsave(&quot;images/coef_lmm.tiff&quot;, width = 5, height = 5, dpi = 300)</span></code></pre></div>

</div>
            </section>

          </div>
        </div>
      </div>
<a href="index.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="Chapitre-Modeling.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"google": false,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"all": ["facebook", "google", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"history": {
"link": null,
"text": null
},
"download": ["2019_Bookdown.pdf", "2019_Bookdown.epub"],
"toc": {
"collapse": "subsection"
}
});
});
</script>

</body>

</html>
