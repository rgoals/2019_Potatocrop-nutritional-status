<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Nutrient Diagnosis Of Potato</title>
  <meta name="description" content="This is a example of using the bookdown package to write a book for publication on Github. The output format for this example is bookdown::gitbook. Next features are set for after (bibliography and links)." />
  <meta name="generator" content="bookdown 0.10 and GitBook 2.6.7" />

  <meta property="og:title" content="Nutrient Diagnosis Of Potato" />
  <meta property="og:type" content="book" />
  
  
  <meta property="og:description" content="This is a example of using the bookdown package to write a book for publication on Github. The output format for this example is bookdown::gitbook. Next features are set for after (bibliography and links)." />
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Nutrient Diagnosis Of Potato" />
  
  <meta name="twitter:description" content="This is a example of using the bookdown package to write a book for publication on Github. The output format for this example is bookdown::gitbook. Next features are set for after (bibliography and links)." />
  

<meta name="author" content="zcoulibali" />


<meta name="date" content="2019-05-26" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  

<link rel="next" href="chapitre-Clustering.html">
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />









<style type="text/css">
div.sourceCode { overflow-x: auto; }
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
code > span.kw { color: #007020; font-weight: bold; } /* Keyword */
code > span.dt { color: #902000; } /* DataType */
code > span.dv { color: #40a070; } /* DecVal */
code > span.bn { color: #40a070; } /* BaseN */
code > span.fl { color: #40a070; } /* Float */
code > span.ch { color: #4070a0; } /* Char */
code > span.st { color: #4070a0; } /* String */
code > span.co { color: #60a0b0; font-style: italic; } /* Comment */
code > span.ot { color: #007020; } /* Other */
code > span.al { color: #ff0000; font-weight: bold; } /* Alert */
code > span.fu { color: #06287e; } /* Function */
code > span.er { color: #ff0000; font-weight: bold; } /* Error */
code > span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
code > span.cn { color: #880000; } /* Constant */
code > span.sc { color: #4070a0; } /* SpecialChar */
code > span.vs { color: #4070a0; } /* VerbatimString */
code > span.ss { color: #bb6688; } /* SpecialString */
code > span.im { } /* Import */
code > span.va { color: #19177c; } /* Variable */
code > span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code > span.op { color: #666666; } /* Operator */
code > span.bu { } /* BuiltIn */
code > span.ex { } /* Extension */
code > span.pp { color: #bc7a00; } /* Preprocessor */
code > span.at { color: #7d9029; } /* Attribute */
code > span.do { color: #ba2121; font-style: italic; } /* Documentation */
code > span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code > span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code > span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">A Minimal Book Example</a></li>

<li class="divider"></li>
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> Data processing</a></li>
<li class="chapter" data-level="2" data-path="chapitre-Clustering.html"><a href="chapitre-Clustering.html"><i class="fa fa-check"></i><b>2</b> Cluster analysis of potato cultivars</a></li>
<li class="chapter" data-level="3" data-path="Chapitre-Modeling.html"><a href="Chapitre-Modeling.html"><i class="fa fa-check"></i><b>3</b> Predicting marketable tuber yield</a></li>
<li class="chapter" data-level="4" data-path="Chapitre-Perturbation-vector.html"><a href="Chapitre-Perturbation-vector.html"><i class="fa fa-check"></i><b>4</b> Perturbation vector theory</a><ul>
<li class="chapter" data-level="4.1" data-path="Chapitre-Perturbation-vector.html"><a href="Chapitre-Perturbation-vector.html#dissimilarity-index-between-compositions"><i class="fa fa-check"></i><b>4.1</b> Dissimilarity index between compositions</a></li>
<li class="chapter" data-level="4.2" data-path="Chapitre-Perturbation-vector.html"><a href="Chapitre-Perturbation-vector.html#rebalancing-a-misbalanced-sample-by-perturbation"><i class="fa fa-check"></i><b>4.2</b> Rebalancing a misbalanced sample by perturbation</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="references.html"><a href="references.html"><i class="fa fa-check"></i>References</a></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Nutrient Diagnosis Of Potato</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="header">
<h1 class="title">Nutrient Diagnosis Of Potato</h1>
<p class="author"><em>zcoulibali</em></p>
<p class="date"><em>2019-05-26</em></p>
</div>
<div id="chapitre-Data-Processing" class="section level1">
<h1><span class="header-section-number">Chapter 1</span> Data processing</h1>
<p>We need package <code>tidyverse</code> for data handling, <code>DBI</code> and <code>RSQLite</code> packages to make connexion and extract usefull tables in the potato historical database file <code>pomme_de_terre.db</code>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(<span class="st">&quot;tidyverse&quot;</span>)  <span class="co"># loads dplyr &amp; ggplot2</span>
<span class="kw">library</span>(<span class="st">&quot;DBI&quot;</span>)        <span class="co"># Database Interface for R</span>
<span class="kw">library</span>(<span class="st">&quot;RSQLite&quot;</span>)    <span class="co"># SQLite Interface for R</span>
db &lt;-<span class="st"> </span><span class="kw">dbConnect</span>(<span class="kw">SQLite</span>(), <span class="dt">dbname =</span> <span class="st">&quot;data/pomme_de_terre.db&quot;</span>)  <span class="co"># Connect to potato database</span></code></pre></div>
<p>Select tables in the created connexion.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">data_df &lt;-<span class="st"> </span><span class="kw">dbReadTable</span>(db, <span class="st">&quot;MetaData&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">left_join</span>(<span class="kw">dbReadTable</span>(db, <span class="st">&quot;FoliarAnalysis&quot;</span>), <span class="dt">by=</span><span class="st">&#39;NoEssai&#39;</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">left_join</span>(<span class="kw">dbReadTable</span>(db, <span class="st">&quot;TreatmentVariable&quot;</span>), <span class="dt">by=</span><span class="kw">c</span>(<span class="st">&#39;NoEssai&#39;</span>, <span class="st">&#39;NoBloc&#39;</span>, <span class="st">&#39;NoTraitement&#39;</span>)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">left_join</span>(<span class="kw">dbReadTable</span>(db, <span class="st">&quot;MaturityOrder&quot;</span>), <span class="dt">by =</span> <span class="st">&#39;Cultivar&#39;</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">as_tibble</span>()</code></pre></div>
<p>Load recent collected trials data from the project experiments and the Quebec Ministry of Agriculture, Fisheries and Food (MAPAQ) trials.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">trials_df &lt;-<span class="st"> </span><span class="kw">read.csv2</span>(<span class="st">&quot;data/donneesEssaisPdt.csv&quot;</span>, <span class="dt">sep =</span> <span class="st">&#39;;&#39;</span>, <span class="dt">dec =</span> <span class="st">&#39;.&#39;</span>)</code></pre></div>
<p>Select usefull variables</p>
<p>Select usefull columns for computations, with macroelements <code>N, P, K, Mg, Ca</code> only because oligoelements have too much missing data. The year is not needed instead it permits to know how long ago expériements have been monitored. Geographical coordinates are used to map sites locations.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">keys_col &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&#39;NoEssai&#39;</span>, <span class="st">&#39;NoBloc&#39;</span>, <span class="st">&#39;NoTraitement&#39;</span>)
macro &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;AnalyseFoliaireN&quot;</span>,<span class="st">&quot;AnalyseFoliaireP&quot;</span>,<span class="st">&quot;AnalyseFoliaireK&quot;</span>, <span class="st">&quot;AnalyseFoliaireCa&quot;</span>,<span class="st">&quot;AnalyseFoliaireMg&quot;</span>)
coord_year &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&#39;Annee&#39;</span>, <span class="st">&#39;LatDD&#39;</span>, <span class="st">&#39;LonDD&#39;</span>)
cult_yield &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&#39;Cultivar&#39;</span>, <span class="st">&#39;Maturity5&#39;</span>, <span class="st">&#39;RendVendable&#39;</span>)
usefull_col &lt;-<span class="st"> </span><span class="kw">c</span>(keys_col, macro, coord_year, cult_yield, <span class="st">&#39;AnalyseFoliaireStade&#39;</span>)
macro_elts &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;N&quot;</span>, <span class="st">&quot;P&quot;</span>, <span class="st">&quot;K&quot;</span>, <span class="st">&quot;Ca&quot;</span>, <span class="st">&quot;Mg&quot;</span>) <span class="co"># for simplicity</span></code></pre></div>
<p>Reduced and joined data frame becomes <code>fol_df</code> the foliar data frame:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">data_df &lt;-<span class="st"> </span>data_df <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(usefull_col)
trials_df &lt;-<span class="st"> </span>trials_df <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(usefull_col)
fol_df &lt;-<span class="st"> </span><span class="kw">rbind</span>(data_df, trials_df)
<span class="kw">colnames</span>(fol_df)[<span class="kw">which</span>(<span class="kw">names</span>(fol_df) <span class="op">%in%</span><span class="st"> </span>macro)] &lt;-<span class="st"> </span>macro_elts
<span class="kw">glimpse</span>(fol_df)</code></pre></div>
<pre><code>## Observations: 12,991
## Variables: 15
## $ NoEssai              &lt;int&gt; 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,...
## $ NoBloc               &lt;int&gt; 1, 1, 1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, 2,...
## $ NoTraitement         &lt;int&gt; 1, 2, 3, 4, 5, 6, 7, 8, 1, 2, 3, 4, 5, 6,...
## $ N                    &lt;dbl&gt; 3.805, 3.356, 3.657, 3.610, 4.983, 4.277,...
## $ P                    &lt;dbl&gt; 0.22, 0.20, 0.22, 0.18, 0.22, 0.21, 0.28,...
## $ K                    &lt;dbl&gt; 6.31, 6.85, 6.44, 5.36, 5.92, 6.73, 5.75,...
## $ Ca                   &lt;dbl&gt; 1.69, 1.31, 1.13, 1.30, 1.23, 1.38, 1.17,...
## $ Mg                   &lt;dbl&gt; 0.53, 0.21, 0.32, 0.50, 0.44, 0.45, 0.51,...
## $ Annee                &lt;int&gt; 2003, 2003, 2003, 2003, 2003, 2003, 2003,...
## $ LatDD                &lt;dbl&gt; 46.75306, 46.75306, 46.75306, 46.75306, 4...
## $ LonDD                &lt;dbl&gt; -72.33861, -72.33861, -72.33861, -72.3386...
## $ Cultivar             &lt;chr&gt; &quot;Goldrush&quot;, &quot;Goldrush&quot;, &quot;Goldrush&quot;, &quot;Gold...
## $ Maturity5            &lt;chr&gt; &quot;mid-season&quot;, &quot;mid-season&quot;, &quot;mid-season&quot;,...
## $ RendVendable         &lt;dbl&gt; 18.9442, 40.3518, 33.0379, 37.5505, 46.00...
## $ AnalyseFoliaireStade &lt;chr&gt; &quot;10% fleur&quot;, &quot;10% fleur&quot;, &quot;10% fleur&quot;, &quot;1...</code></pre>
<p>Arrange data table</p>
<p>Set trial number as factor</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">fol_df<span class="op">$</span>NoEssai &lt;-<span class="st"> </span><span class="kw">as.factor</span>(fol_df<span class="op">$</span>NoEssai)</code></pre></div>
<p>Choose cultivar <code>Goldrush</code> as reference, it as the maximum number of observations in the data frame.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">fol_df<span class="op">$</span>Cultivar &lt;-<span class="st">  </span><span class="kw">relevel</span>(<span class="kw">factor</span>(fol_df<span class="op">$</span>Cultivar), <span class="dt">ref =</span> <span class="st">&quot;Goldrush&quot;</span>)</code></pre></div>
<p>Relevel categorical <code>maturity</code> order.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">fol_df<span class="op">$</span>Maturity5 &lt;-<span class="st"> </span><span class="kw">ordered</span>(fol_df<span class="op">$</span>Maturity5, 
                            <span class="dt">levels =</span> <span class="kw">c</span>(<span class="st">&quot;early&quot;</span>,<span class="st">&quot;early mid-season&quot;</span>,<span class="st">&quot;mid-season&quot;</span>,<span class="st">&quot;mid-season late&quot;</span>,<span class="st">&quot;late&quot;</span>))</code></pre></div>
<p>Leaf ionome with macroelements</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">leafIonome &lt;-<span class="st"> </span>fol_df[macro_elts]</code></pre></div>
<p>Some custom functions are used for compositional analysis. The libraries <code>robCompositions</code>, <code>compositions</code> and <code>Amelia</code> are used for robust imputation with kNN (long process), compositional transformations and to portrait missing values respectively.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">source</span>(<span class="st">&#39;https://raw.githubusercontent.com/essicolo/AgFun/master/ilrNA.R&#39;</span>)
<span class="kw">source</span>(<span class="st">&#39;https://raw.githubusercontent.com/essicolo/AgFun/master/ilrDefinition.R&#39;</span>)
<span class="kw">source</span>(<span class="st">&quot;https://raw.githubusercontent.com/essicolo/AgFun/master/codadend2.R&quot;</span>)</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(<span class="st">&quot;robCompositions&quot;</span>)  <span class="co"># impCoda &amp; impKNNa: for data imputation</span>
<span class="kw">library</span>(<span class="st">&quot;compositions&quot;</span>)  <span class="co"># for ILR transformations: acomp, ilr, ilrInv</span>
<span class="kw">require</span>(<span class="st">&#39;Amelia&#39;</span>)   <span class="co"># Portrait of missing values</span></code></pre></div>
<p>Portrait of missing macroelements</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">missmap</span>(leafIonome)</code></pre></div>
<div class="figure" style="text-align: center"><span id="fig:matrix-missing-data"></span>
<img src="2019_Bookdown_files/figure-html/matrix-missing-data-1.png" alt="Portrait of missing macroelements." width="100%" />
<p class="caption">
Figure 1.1: Portrait of missing macroelements.
</p>
</div>
<p>Impute missing data for samples (rows) with less than 3 missing elements among the five. The next cell initializes this computation codes.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># keep track of empty rows:</span>
fol_df<span class="op">$</span>leafIonome_allNA &lt;-<span class="st"> </span><span class="kw">apply</span>(fol_df[macro_elts], <span class="dv">1</span>, <span class="cf">function</span>(X) <span class="kw">all</span>(<span class="kw">is.na</span>(X)))
<span class="co"># keep track of rows where there is any NA:</span>
fol_df<span class="op">$</span>leafIonome_anyNA &lt;-<span class="st"> </span><span class="kw">apply</span>(fol_df[macro_elts], <span class="dv">1</span>, <span class="cf">function</span>(X) <span class="kw">any</span>(<span class="kw">is.na</span>(X)))
<span class="co"># number of NAs (missing values):</span>
fol_df<span class="op">$</span>leafIonome_countNA &lt;-<span class="st"> </span><span class="kw">apply</span>(fol_df[macro_elts], <span class="dv">1</span>, <span class="cf">function</span>(X) <span class="kw">sum</span>(<span class="kw">is.na</span>(X)))
<span class="co"># Only impute if the next variable value is set to FALSE</span>
fol_df<span class="op">$</span>leafIonome_hasTooMuchNA &lt;-<span class="st"> </span>fol_df<span class="op">$</span>leafIonome_countNA <span class="op">&gt;=</span><span class="st"> </span><span class="dv">3</span></code></pre></div>
<p>Imputation:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Warning: could be a long process</span>
leaf_imputeRob &lt;-<span class="st"> </span><span class="kw">impKNNa</span>(<span class="kw">as.matrix</span>(fol_df[<span class="op">!</span>fol_df<span class="op">$</span>leafIonome_hasTooMuchNA, macro_elts]),
                           <span class="dt">metric =</span> <span class="st">&quot;Aitchison&quot;</span>, <span class="dt">k =</span> <span class="dv">6</span>, <span class="dt">primitive =</span> <span class="ot">TRUE</span>,
                           <span class="dt">normknn =</span> <span class="ot">TRUE</span>, <span class="dt">adj =</span> <span class="st">&#39;median&#39;</span>)
<span class="kw">colnames</span>(leaf_imputeRob<span class="op">$</span>xImp) &lt;-<span class="st"> </span><span class="kw">paste0</span>(<span class="kw">colnames</span>(leaf_imputeRob<span class="op">$</span>xImp), <span class="st">&#39;_imp&#39;</span>)
leaf_imputeRob<span class="op">$</span>xImp <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">head</span>() <span class="co"># a view of new imputed compositions</span></code></pre></div>
<pre><code>##      N_imp P_imp K_imp Ca_imp Mg_imp
## [1,] 3.805  0.22  6.31   1.69   0.53
## [2,] 3.356  0.20  6.85   1.31   0.21
## [3,] 3.657  0.22  6.44   1.13   0.32
## [4,] 3.610  0.18  5.36   1.30   0.50
## [5,] 4.983  0.22  5.92   1.23   0.44
## [6,] 4.277  0.21  6.73   1.38   0.45</code></pre>
<p>Push imputed columns to the data frame. The nutrients diagnosis will be performed with imputed compositions.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">fol_df &lt;-<span class="st"> </span><span class="kw">left_join</span>(<span class="dt">x =</span> fol_df,
                     <span class="dt">y =</span> <span class="kw">data.frame</span>(<span class="dt">NoEssai =</span> fol_df<span class="op">$</span>NoEssai[<span class="op">!</span>fol_df<span class="op">$</span>leafIonome_hasTooMuchNA],
                                    <span class="dt">NoBloc =</span> fol_df<span class="op">$</span>NoBloc[<span class="op">!</span>fol_df<span class="op">$</span>leafIonome_hasTooMuchNA],
                                    <span class="dt">NoTraitement =</span> fol_df<span class="op">$</span>NoTraitement[<span class="op">!</span>fol_df<span class="op">$</span>leafIonome_hasTooMuchNA],
                                    leaf_imputeRob<span class="op">$</span>xImp),
                     <span class="dt">by =</span> keys_col)
fol_df &lt;-<span class="st"> </span>fol_df <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(<span class="op">-</span><span class="kw">c</span>(<span class="st">&quot;leafIonome_allNA&quot;</span>, <span class="st">&quot;leafIonome_anyNA&quot;</span>, <span class="st">&quot;leafIonome_countNA&quot;</span>,                                                     <span class="st">&quot;leafIonome_hasTooMuchNA&quot;</span>))</code></pre></div>
<p>Compute Fv. <code>Fv</code> stands for filling value, an amalgamation of all other elements closing the simplex to 100%.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">fol_df<span class="op">$</span>Fv_imp &lt;-<span class="st"> </span><span class="dv">100</span> <span class="op">-</span><span class="st"> </span><span class="kw">rowSums</span>(fol_df[, <span class="kw">colnames</span>(leaf_imputeRob<span class="op">$</span>xImp)]) <span class="co"># computes the Fv</span>
leaf.macro_imp &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="kw">colnames</span>(leaf_imputeRob<span class="op">$</span>xImp), <span class="st">&#39;Fv_imp&#39;</span>) <span class="co"># new colnames vector of macroelements</span>
leaf.macro_imp</code></pre></div>
<pre><code>## [1] &quot;N_imp&quot;  &quot;P_imp&quot;  &quot;K_imp&quot;  &quot;Ca_imp&quot; &quot;Mg_imp&quot; &quot;Fv_imp&quot;</code></pre>
<p>Compute centered log-ratios <code>clr</code> only for complete cases.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">leafIonomeComp &lt;-<span class="st"> </span><span class="kw">acomp</span>(fol_df[leaf.macro_imp])
leafIonomeClr &lt;-<span class="st"> </span><span class="kw">clr</span>(leafIonomeComp)</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">leafIonomeClr[<span class="kw">apply</span>(leafIonomeComp, <span class="dv">1</span>, anyNA), ] &lt;-<span class="st"> </span><span class="ot">NA</span>   <span class="co"># discard for rows with any NA</span>
leafIonomeDefClr &lt;-<span class="st"> </span><span class="kw">paste0</span>(<span class="st">&quot;clr_&quot;</span>, <span class="kw">c</span>(macro_elts, <span class="st">&#39;Fv&#39;</span>))  <span class="co"># computed clr colnames vector</span>
<span class="kw">colnames</span>(leafIonomeClr) &lt;-<span class="st"> </span>leafIonomeDefClr
leafIonomeClr &lt;-<span class="st"> </span><span class="kw">cbind</span>(fol_df[keys_col], leafIonomeClr)  <span class="co"># bind clr variables to keys columns</span></code></pre></div>
<p>Push clr coordinates to <code>fol_df</code> and reduce the data frame to usefull columns</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">fol_df &lt;-<span class="st"> </span><span class="kw">left_join</span>(fol_df, leafIonomeClr, <span class="dt">by =</span> keys_col)
fol_df &lt;-<span class="st"> </span>fol_df <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(keys_col, coord_year, cult_yield, <span class="st">&quot;AnalyseFoliaireStade&quot;</span>, leafIonomeDefClr)
<span class="kw">glimpse</span>(fol_df)</code></pre></div>
<pre><code>## Observations: 12,991
## Variables: 16
## $ NoEssai              &lt;fct&gt; 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,...
## $ NoBloc               &lt;int&gt; 1, 1, 1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, 2,...
## $ NoTraitement         &lt;int&gt; 1, 2, 3, 4, 5, 6, 7, 8, 1, 2, 3, 4, 5, 6,...
## $ Annee                &lt;int&gt; 2003, 2003, 2003, 2003, 2003, 2003, 2003,...
## $ LatDD                &lt;dbl&gt; 46.75306, 46.75306, 46.75306, 46.75306, 4...
## $ LonDD                &lt;dbl&gt; -72.33861, -72.33861, -72.33861, -72.3386...
## $ Cultivar             &lt;fct&gt; Goldrush, Goldrush, Goldrush, Goldrush, G...
## $ Maturity5            &lt;ord&gt; mid-season, mid-season, mid-season, mid-s...
## $ RendVendable         &lt;dbl&gt; 18.9442, 40.3518, 33.0379, 37.5505, 46.00...
## $ AnalyseFoliaireStade &lt;chr&gt; &quot;10% fleur&quot;, &quot;10% fleur&quot;, &quot;10% fleur&quot;, &quot;1...
## $ clr_N                &lt;dbl&gt; 0.3321186, 0.4252302, 0.4453417, 0.399326...
## $ clr_P                &lt;dbl&gt; -2.518325, -2.394957, -2.365429, -2.59918...
## $ clr_K                &lt;dbl&gt; 0.83793831, 1.13872910, 1.01122715, 0.794...
## $ clr_Ca               &lt;dbl&gt; -0.4794688, -0.5154924, -0.7290838, -0.62...
## $ clr_Mg               &lt;dbl&gt; -1.639076, -2.346167, -1.990736, -1.57752...
## $ clr_Fv               &lt;dbl&gt; 3.466813, 3.692658, 3.628680, 3.604817, 3...</code></pre>
<p>Map experimental sites locations</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(<span class="st">&quot;ggmap&quot;</span>) <span class="co"># maps with ggplot2</span>
<span class="kw">library</span>(<span class="st">&quot;extrafont&quot;</span>) <span class="co"># Changing Fonts for Graphs</span>
qc_fol &lt;-<span class="st"> </span><span class="kw">get_stamenmap</span>(<span class="dt">bbox =</span> <span class="kw">c</span>(<span class="dt">left=</span><span class="op">-</span><span class="dv">76</span>, <span class="dt">right=</span><span class="op">-</span><span class="dv">68</span>, <span class="dt">bottom=</span><span class="dv">45</span>, <span class="dt">top=</span><span class="dv">50</span>), 
                        <span class="dt">zoom=</span><span class="dv">7</span>, <span class="dt">maptype =</span> <span class="st">&#39;toner-lite&#39;</span>)
<span class="kw">ggmap</span>(qc_fol) <span class="op">+</span>
<span class="st">  </span><span class="kw">geom_point</span>(<span class="dt">data=</span><span class="kw">unique</span>(fol_df[<span class="kw">c</span>(<span class="st">&#39;LonDD&#39;</span>, <span class="st">&#39;LatDD&#39;</span>)]), <span class="kw">aes</span>(<span class="dt">x=</span>LonDD, <span class="dt">y=</span>LatDD),
             <span class="dt">size=</span><span class="dv">3</span>, <span class="dt">shape=</span><span class="dv">16</span>, <span class="dt">colour=</span><span class="st">&#39;aquamarine4&#39;</span>, <span class="dt">alpha=</span><span class="fl">0.8</span>) <span class="op">+</span><span class="st"> </span><span class="kw">coord_map</span>(<span class="st">&quot;mercator&quot;</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">theme_bw</span>() <span class="op">+</span>
<span class="st">  </span><span class="kw">theme</span>(<span class="dt">text=</span><span class="kw">element_text</span>(<span class="dt">family=</span><span class="st">&quot;Arial&quot;</span>, <span class="dt">face=</span><span class="st">&quot;bold&quot;</span>, <span class="dt">size=</span><span class="dv">12</span>))</code></pre></div>
<div class="figure" style="text-align: center"><span id="fig:fol-locations"></span>
<img src="2019_Bookdown_files/figure-html/fol-locations-1.png" alt="Location of experimental sites (green dots) in the Québec potato data set." width="100%" />
<p class="caption">
Figure 1.2: Location of experimental sites (green dots) in the Québec potato data set.
</p>
</div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co">#ggsave(&quot;images/fol-locations.png&quot;, width=10, height=8)</span></code></pre></div>
<p>Cultivars classes correction.</p>
<p>Cultivar <code>Mystere</code> and <code>Vivaldi</code> have different maturity classes in the data set, <code>mid-season late</code> and <code>late</code> for <code>Mystere</code>, then <code>early mid-season</code> and <code>mid-season</code> for <code>Vivaldi</code>. Their new maturity classes names are based on a majority vote.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">fol_df<span class="op">$</span>Maturity5[fol_df<span class="op">$</span>Cultivar <span class="op">==</span><span class="st"> &quot;Mystere&quot;</span>] &lt;-<span class="st"> &quot;late&quot;</span>
fol_df<span class="op">$</span>Maturity5[fol_df<span class="op">$</span>Cultivar <span class="op">==</span><span class="st"> &quot;Vivaldi&quot;</span>] &lt;-<span class="st"> &quot;early mid-season&quot;</span>
fol_df<span class="op">$</span>Cultivar &lt;-<span class="st"> </span>forcats<span class="op">::</span><span class="kw">fct_explicit_na</span>(fol_df<span class="op">$</span>Cultivar)</code></pre></div>
<p>Summarise the data frame.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">fol_df <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">summarise</span>(<span class="dt">start_year =</span> <span class="kw">min</span>(Annee, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>),
            <span class="dt">end_year =</span> <span class="kw">max</span>(Annee, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>),
            <span class="dt">nbr_trials =</span> <span class="kw">n_distinct</span>(NoEssai, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>),
            <span class="dt">nbr_cultivars =</span> <span class="kw">n_distinct</span>(Cultivar, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>),
            <span class="dt">nbr_maturityClass =</span> <span class="kw">n_distinct</span>(Maturity5, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>)
            )</code></pre></div>
<pre><code>## # A tibble: 1 x 5
##   start_year end_year nbr_trials nbr_cultivars nbr_maturityClass
##        &lt;int&gt;    &lt;int&gt;      &lt;int&gt;         &lt;int&gt;             &lt;int&gt;
## 1       1958     2017       4930            60                 5</code></pre>
<p>Backup for cluster analysis:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">write.csv2</span>(fol_df, <span class="st">&#39;data/fol_df.csv&#39;</span>)</code></pre></div>

</div>
            </section>

          </div>
        </div>
      </div>

<a href="chapitre-Clustering.html" class="navigation navigation-next navigation-unique" aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"google": false,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"all": ["facebook", "google", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"history": {
"link": null,
"text": null
},
"download": ["2019_Bookdown.pdf", "2019_Bookdown.epub"],
"toc": {
"collapse": "subsection"
}
});
});
</script>

</body>

</html>
